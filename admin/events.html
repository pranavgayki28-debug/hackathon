<!DOCTYPE html>
<html>
<head>
<title>Manage Events</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    background: linear-gradient(135deg, #0a0015 0%, #1a0033 50%, #0f001f 100%);
    font-family: 'Poppins', sans-serif;
    color: white;
    padding: 40px;
}

.container {
    max-width: 1200px;
    margin: auto;
}

.form-box {
    background: rgba(10, 0, 30, 0.8);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 0 40px rgba(138, 43, 226, 0.6);
    margin-bottom: 60px;
}

.form-box h2 {
    text-align: center;
    margin-bottom: 20px;
}

input, button {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: none;
}

input {
    background: rgba(255,255,255,0.05);
    color: white;
    border: 1px solid rgba(138,43,226,0.5);
}

button {
    background: linear-gradient(90deg, #8A2BE2, #FF1493);
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 30px;
}

.event-card {
    background: rgba(10, 0, 30, 0.8);
    border-radius: 20px;
    overflow: hidden;
    text-align: center;
    box-shadow: 0 0 20px rgba(138,43,226,0.5);
}

.event-card img {
    width: 100%;
    height: 300px;
    object-fit: contain;
    background: rgba(255,255,255,0.05);
}

.event-name {
    padding: 15px;
    font-weight: 600;
}

.action-buttons {
    display: flex;
}

.action-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.edit-btn { background: #4CAF50; }
.delete-btn { background: #e91e63; }

</style>
</head>

<body>

<div class="container">

<div class="form-box">
    <h2 id="formTitle">Add Event</h2>

    <form id="eventForm">
        <input type="hidden" id="editIndex">

        <input type="text" id="eventName"
               placeholder="Event Name"
               required>

        <input type="text" id="eventDate"
               placeholder="Event Date (e.g. 16 January 2026 or Online Competition)"
               required>

        <input type="file" id="thumbnail" accept="image/*">

        <button type="submit">Save Event</button>
    </form>
</div>

<h2 style="margin-bottom:30px;">All Events</h2>

<div class="events-grid" id="eventsGrid"></div>

</div>

<script type="module">

// 1. Paste the updated imports here
import { db } from "../firebase.js";
import {
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


// 2. Add this helper function to convert the image to text
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

const form = document.getElementById("eventForm");
const grid = document.getElementById("eventsGrid");
let editId = null;

/* ================= LOAD EVENTS ================= */
// ... rest of your code ...
/* ================= LOAD EVENTS ================= */

async function loadEvents() {
  grid.innerHTML = "";

  const querySnapshot = await getDocs(collection(db, "events"));

  querySnapshot.forEach((document) => {
    const event = document.data();

    grid.innerHTML += `
      <div class="event-card">
          <img src="${event.image || 'https://via.placeholder.com/300'}">
          <div class="event-name">
              ${event.name}<br>
              <small>${event.date}</small>
          </div>
          <div class="action-buttons">
              <button class="edit-btn" onclick="editEvent('${document.id}','${event.name}','${event.date}')">Edit</button>
              <button class="delete-btn" onclick="deleteEvent('${document.id}','${event.image}')">Delete</button>
          </div>
      </div>
    `;
  });
}

window.loadEvents = loadEvents;

/* ================= ADD / UPDATE EVENT ================= */

/* ================= ADD / UPDATE EVENT ================= */

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("eventName").value;
  const date = document.getElementById("eventDate").value;
  const file = document.getElementById("thumbnail").files[0];

  let imageUrl = "";

  // 1. Convert file to Base64 text string
  if (file) {
    try {
      imageUrl = await toBase64(file); 
      console.log("Image converted to Base64 string");
    } catch (error) {
      console.error("Conversion error:", error);
      alert("Error processing image.");
      return;
    }
  }

  try {
    if (editId) {
      // UPDATE EXISTING EVENT
      const updateData = { name, date };
      
      // Only update image if a new one was selected
      if (imageUrl) {
        updateData.image = imageUrl;
      }

      await updateDoc(doc(db, "events", editId), updateData);
      console.log("Event updated in Firestore");

      editId = null;
      document.getElementById("formTitle").innerText = "Add Event";
    } else {
      // ADD NEW EVENT
      if (!imageUrl) {
        alert("Please upload an image");
        return;
      }

      await addDoc(collection(db, "events"), {
        name,
        date,
        image: imageUrl, // Saving the long string here
        createdAt: serverTimestamp(),
      });
      console.log("Event added to Firestore");
    }

    form.reset();
    loadEvents();
  } catch (error) {
    console.error("Firestore error:", error);
    // This usually happens if the image string makes the document > 1MB
    alert("Error saving to Firestore. Is the image too large? (Max 1MB)");
  }
});

/* ================= DELETE ================= */

window.deleteEvent = async (id) => {
  if (!confirm("Delete this event?")) return;

  try {
    await deleteDoc(doc(db, "events", id));
    loadEvents();
  } catch (error) {
    console.error("Delete error:", error);
  }
};
/* ================= EDIT ================= */

window.editEvent = (id, name, date) => {
  editId = id;

  document.getElementById("formTitle").innerText = "Edit Event";
  document.getElementById("eventName").value = name;
  document.getElementById("eventDate").value = date;
};

loadEvents();

</script>
</body>
</html>