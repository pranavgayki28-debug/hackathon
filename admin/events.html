<!DOCTYPE html>
<html>
<head>
<title>Manage Events</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    background: linear-gradient(135deg, #0a0015 0%, #1a0033 50%, #0f001f 100%);
    font-family: 'Poppins', sans-serif;
    color: white;
    padding: 40px;
}

.container {
    max-width: 1200px;
    margin: auto;
}

.form-box {
    background: rgba(10, 0, 30, 0.8);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 0 40px rgba(138, 43, 226, 0.6);
    margin-bottom: 60px;
}

.form-box h2 {
    text-align: center;
    margin-bottom: 20px;
}

input, button {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: none;
}

input {
    background: rgba(255,255,255,0.05);
    color: white;
    border: 1px solid rgba(138,43,226,0.5);
}

button {
    background: linear-gradient(90deg, #8A2BE2, #FF1493);
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 30px;
}

.event-card {
    background: rgba(10, 0, 30, 0.8);
    border-radius: 20px;
    overflow: hidden;
    text-align: center;
    box-shadow: 0 0 20px rgba(138,43,226,0.5);
}

.event-card img {
    width: 100%;
    height: 300px;
    object-fit: contain;
    background: rgba(255,255,255,0.05);
}

.event-name {
    padding: 15px;
    font-weight: 600;
}

.action-buttons {
    display: flex;
}

.action-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    color: white;
    font-weight: 600;
    cursor: pointer;
}

.edit-btn { background: #4CAF50; }
.delete-btn { background: #e91e63; }

</style>
</head>

<body>

<div class="container">

<div class="form-box">
    <h2 id="formTitle">Add Event</h2>

    <form id="eventForm">
        <input type="hidden" id="editIndex">

        <input type="text" id="eventName"
               placeholder="Event Name"
               required>

        <input type="text" id="eventDate"
               placeholder="Event Date (e.g. 16 January 2026 or Online Competition)"
               required>

        <input type="file" id="thumbnail" accept="image/*">

        <button type="submit">Save Event</button>
    </form>
</div>

<h2 style="margin-bottom:30px;">All Events</h2>

<div class="events-grid" id="eventsGrid"></div>

</div>

<script type="module">

import { db, storage } from "./firebase.js";

import {
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
  ref,
  uploadBytes,
  getDownloadURL,
  deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const form = document.getElementById("eventForm");
const grid = document.getElementById("eventsGrid");

let editId = null;

/* ================= LOAD EVENTS ================= */

async function loadEvents() {
  grid.innerHTML = "";

  const querySnapshot = await getDocs(collection(db, "events"));

  querySnapshot.forEach((document) => {
    const event = document.data();

    grid.innerHTML += `
      <div class="event-card">
          <img src="${event.image}">
          <div class="event-name">
              ${event.name}<br>
              <small>${event.date}</small>
          </div>
          <div class="action-buttons">
              <button class="edit-btn" onclick="editEvent('${document.id}','${event.name}','${event.date}')">Edit</button>
              <button class="delete-btn" onclick="deleteEvent('${document.id}','${event.image}')">Delete</button>
          </div>
      </div>
    `;
  });
}

window.loadEvents = loadEvents;

/* ================= ADD / UPDATE EVENT ================= */

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("eventName").value;
  const date = document.getElementById("eventDate").value;
  const file = document.getElementById("thumbnail").files[0];

  let imageUrl = "";

  if (file) {
    const storageRef = ref(storage, "events/" + Date.now() + "_" + file.name);
    await uploadBytes(storageRef, file);
    imageUrl = await getDownloadURL(storageRef);
  }

  if (editId) {

    const updateData = { name, date };

    if (imageUrl) {
      updateData.image = imageUrl;
    }

    await updateDoc(doc(db, "events", editId), updateData);

    editId = null;
    document.getElementById("formTitle").innerText = "Add Event";

  } else {

    if (!imageUrl) {
      alert("Please upload image");
      return;
    }

    await addDoc(collection(db, "events"), {
      name,
      date,
      image: imageUrl,
      createdAt: new Date()
    });
  }

  form.reset();
  loadEvents();
});

/* ================= DELETE ================= */

window.deleteEvent = async (id) => {

  if (!confirm("Delete this event?")) return;

  try {
    await deleteDoc(doc(db, "events", id));
    loadEvents();
  } catch (error) {
    console.error("Delete error:", error);
  }
};

/* ================= EDIT ================= */

window.editEvent = (id, name, date) => {
  editId = id;

  document.getElementById("formTitle").innerText = "Edit Event";
  document.getElementById("eventName").value = name;
  document.getElementById("eventDate").value = date;
};

loadEvents();

</script>
</body>
</html>